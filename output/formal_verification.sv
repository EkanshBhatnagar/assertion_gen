////////////////////////////////////////////////////////////////////////////////
// Formal Verification Testbench for FIFO
// Generated by Multi-Stage Assertion Generator - Stage 3
//
// This testbench includes:
// - All module parameters
// - All ports declared as logic
// - DUT instantiation (FIFO as DUT)
// - Refined assertions with correct signal references
// - Internal signals accessed via DUT.signal_name
// - Default clocking and reset handling
//
// Note: Incremental progress saved to: output/refined_assertions_progress.sv
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Testbench for FIFO
// Auto-generated by assertion generation pipeline
// Contains DUT instantiation and formal verification assertions
////////////////////////////////////////////////////////////////////////////////

module FIFO_tb;

    // Parameters
    parameter FIFO_WIDTH = 16;
    parameter FIFO_DEPTH = 8;

    // Port declarations (as logic)
    logic [FIFO_WIDTH-1:0] data_in;
    logic clk;
    logic rst_n;
    logic wr_en;
    logic rd_en;
    logic [FIFO_WIDTH-1:0] data_out;
    logic wr_ack;
    logic overflow;
    logic full;
    logic empty;
    logic almostfull;
    logic almostempty;
    logic underflow;

    // DUT Instantiation
    FIFO #(
        .FIFO_WIDTH(FIFO_WIDTH),
        .FIFO_DEPTH(FIFO_DEPTH)
    ) DUT (
        .data_in(data_in),
        .clk(clk),
        .rst_n(rst_n),
        .wr_en(wr_en),
        .rd_en(rd_en),
        .data_out(data_out),
        .wr_ack(wr_ack),
        .overflow(overflow),
        .full(full),
        .empty(empty),
        .almostfull(almostfull),
        .almostempty(almostempty),
        .underflow(underflow)
    );

    // Default clocking and reset handling
    default clocking cb @(posedge clk);
    endclocking

    default disable iff (!rst_n);

    // Formal Verification Assertions
    assert property (@(posedge clk) disable iff (!rst_n) (!DUT.full && DUT.wr_en) |-> DUT.wr_ack);

    assert property (@(posedge clk)
        disable iff (!rst_n)
          (|!DUT.empty && DUT.rd_en |-> DUT.data_out == $past(DUT.data_in))
      );

    as__fifo_empty_underflow: assert property @ (posedge clk)

    assert property (@(posedge clk) (DUT.count == 4'b0001 |-> DUT.almostempty));

    assert property (@(posedge clk) disable iff (!rst_n)
        (rst_n && !$past(rst_n)) |-> (
            DUT.full          == 1'b0 &&
            DUT.almostfull    == 1'b0 &&
            DUT.empty         == 1'b1 &&
            DUT.almostempty   == 1'b1 &&
            DUT.overflow      == 1'b0 &&
            DUT.underflow     == 1'b0 &&
            DUT.wr_ack        == 1'b0
        )
    );

    assert property (@(posedge clk)
      ((DUT.wr_en && DUT.rd_en) |-> 
       ( ($past(DUT.empty) && (DUT.count == $past(DUT.count)+1'b1)) ||
         ($past(DUT.full)   && (DUT.count == $past(DUT.count)-1'b1)) )
      );

    assert property (
        @(posedge clk)
        disable iff (!rst_n)
        ~DUT.rd_en |-> (DUT.data_out == $past(DUT.data_out))
    );

    assert property (DUT.count == FIFO_DEPTH-1 |-> DUT.almostfull);

    assert property (DUT.count == 1 |-> DUT.almostempty);

    assert property (
      @(posedge clk)
      disable iff (!rst_n)
      (rst_n |=> ##[1:2] (DUT.empty && DUT.count == '0 && DUT.wr_ptr == '0))
    );

    (Empty – no assertion can be generated without a description.)

    assert property (as__fifo_reset_empty:
        $past(DUT.rst_n) && !DUT.rst_n |=> DUT.empty);

    assert property (@(posedge DUT.clk)
      disable iff (!DUT.rst_n)
        (DUT.wr_en && !DUT.full && !DUT.almostfull && !DUT.overflow |=> DUT.wr_ack));

    assert property (@(posedge clk) DUT.empty |-> (DUT.almostempty && !DUT.underflow && !DUT.wr_ack));

    assert property (@(posedge clk) disable iff (!rst_n) (DUT.wr_en |=> DUT.wr_ack));

    assert property (
      @(posedge DUT.clk)
      (DUT.wr_en && DUT.rd_en) |-> (DUT.count == $past(DUT.count)+1'b1)
    );

    (Empty – no assertion can be generated without a description.)

    assert property (@(posedge clk)
      ((DUT.wr_en && DUT.rd_en && !DUT.full && DUT.empty) |-> !DUT.empty));

    assert property (@(posedge DUT.clk)
        (DUT.wr_en && DUT.rd_en && DUT.full && !DUT.empty) |-> !DUT.full);

    assert property (@(posedge clk) disable iff (!rst_n) (DUT.wr_en |=> DUT.wr_ack));

    assert property (@(posedge DUT.clk) !(DUT.overflow && DUT.underflow));

    assert property (!DUT.rd_en |-> $stable(DUT.data_out));

endmodule

////////////////////////////////////////////////////////////////////////////////
// End of Formal Verification Testbench
////////////////////////////////////////////////////////////////////////////////
